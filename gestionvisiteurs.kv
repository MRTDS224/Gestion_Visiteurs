#:kivy 2.3.1
#:import MDBoxLayout kivymd.uix.boxlayout.MDBoxLayout
#:import MDButton kivymd.uix.button.MDButton
#:import MDLabel kivymd.uix.label.MDLabel
#:import dp kivy.metrics.dp
#:import ScreenManager kivy.uix.screenmanager.ScreenManager

ScreenManager:
    canvas.before:
        Color:
            rgba: 0.95, 0.97, 1, 1
        Rectangle:
            pos: self.pos
            size: self.size
    LoginScreen:
        name: "login"
    SignupScreen:
        name: "signup"
    ResetPasswordScreen:
        name: "reset"
    CodeInputScreen:
        name: "code_input"
    AccueilScreen:
        name: "accueil"
    HistoriqueScreen:
        name: "historique"

<LoginScreen>:
    MDCard:
        style: "elevated"
        pos_hint: {"center_x": .5, "center_y": .5}
        padding: "4dp"
        size_hint: .5, .6
        # Sets custom properties.
        theme_shadow_color: "Custom"
        shadow_color: "red"
        theme_bg_color: "Custom"
        MDBoxLayout:
            orientation: "vertical"
            spacing: "10dp"
            MDLabel:
                text: "CONNEXION"
                halign: "center"

            MDTextField:
                id: login_email
                size_hint_x: .5
                pos_hint: {"center_x": 0.5}
                validator: "email"
                required: True
                MDTextFieldHintText:
                    text: "Email"
                MDTextFieldHelperText:
                    mode: "on_error"
                MDTextFieldLeadingIcon:
                    icon: "email"

            MDTextField:
                id: login_password
                password: True
                required: True
                size_hint_x: .5
                pos_hint: {"center_x": 0.5}
                MDTextFieldHintText:
                    text: "Mot de passe"
                MDTextFieldHelperText:
                    mode: "on_error"
                MDTextFieldLeadingIcon:
                    icon: "eye-off"

            MDButton:
                style: "text"
                pos_hint: {"center_x": 0.5}
                on_release: root.manager.current = "reset"
                MDButtonText:
                    text: "Mot de passe oublié ?"

            MDButton:
                style: "text"
                pos_hint: {"center_x": 0.5}
                on_release: root.manager.current = "signup"
                MDButtonText:
                    text: "Pas encore inscrit ? S’inscrire"
            MDButton:
                style: "elevated"
                pos_hint: {"center_x": 0.5}
                on_release: app.login()
                MDButtonText:
                    text: "Se connecter"

<SignupScreen>:
    MDCard:
        style: "elevated"
        pos_hint: {"center_x": .5, "center_y": .5}
        padding: "4dp"
        size_hint: .5, .9
        # Sets custom properties.
        theme_shadow_color: "Custom"
        shadow_color: "yellow"
        theme_bg_color: "Custom"
        MDBoxLayout:
            orientation: "vertical"
            spacing: "10dp"

            MDLabel:
                text: "INSCRIPTION"
                halign: "center"

            MDTextField:
                id: signup_last_name
                size_hint_x: .6
                pos_hint: {"center_x": 0.5}
                required: True
                MDTextFieldHintText:
                    text: "Nom"
                MDTextFieldLeadingIcon:
                    icon: "account"
            
            MDTextField:
                id: signup_first_name
                size_hint_x: .6
                pos_hint: {"center_x": 0.5}
                required: True
                MDTextFieldHintText:
                    text: "Prenom"
                MDTextFieldLeadingIcon:
                    icon: "account"

            MDTextField:
                id: signup_email
                validator: "email"
                required: True
                size_hint_x: .6
                pos_hint: {"center_x": 0.5}
                MDTextFieldHintText:
                    text: "Email"
                MDTextFieldHelperText:
                    mode: "on_error"
                MDTextFieldLeadingIcon:
                    icon: "email"

            MDTextField:
                id: signup_password_first
                size_hint_x: .6
                pos_hint: {"center_x": 0.5}
                password: True
                required: True
                MDTextFieldHintText:
                    text: "Mot de passe"
                MDTextFieldLeadingIcon:
                    icon: "eye-off"
            MDTextField:
                id: signup_password_second
                size_hint_x: .6
                pos_hint: {"center_x": 0.5}
                password: True
                required: True
                MDTextFieldHintText:
                    text: "Mot de passe à nouveau"
                MDTextFieldLeadingIcon:
                    icon: "eye-off"
            
            MDTextField:
                id: signup_role
                size_hint_x: .6
                pos_hint: {"center_x": 0.5}
                password: True
                required: True
                MDTextFieldHintText:
                    text: "Rôle"
                MDTextFieldLeadingIcon:
                    icon: "account-cog"
                MDTextFieldHelperText:
                    text: "Huissier ou Autre"

            MDButton:
                style: "elevated"
                pos_hint: {"center_x": 0.6}
                on_release: app.signup()
                MDButtonText:
                    text: "S’inscrire"

            MDButton:
                style: "text"
                pos_hint: {"center_x": 0.5}
                on_release: root.manager.current = "login"
                MDButtonText:
                    text: "Déjà inscrit ? Se connecter"


<ResetPasswordScreen>:
    MDCard:
        style: "elevated"
        pos_hint: {"center_x": .5, "center_y": .5}
        padding: "4dp"
        size_hint: .5, .5
        # Sets custom properties.
        theme_shadow_color: "Custom"
        shadow_color: "green"
        theme_bg_color: "Custom"
        MDBoxLayout:
            orientation: "vertical"
            spacing: "10dp"
            MDLabel:
                text: "RÉINITIALISER LE MOT DE PASSE"
                halign: "center"

            MDTextField:
                id: reset_email
                validator: "email"
                required: True
                size_hint_x: .5
                pos_hint: {"center_x": 0.5}
                MDTextFieldHintText:
                    text: "Votre email"
                MDTextFieldHelperText:
                    mode: "on_error"
                MDTextFieldLeadingIcon:
                    icon: "email"

            MDButton:
                style: "elevated"
                pos_hint: {"center_x": 0.5}
                on_release: app.send_reset_code()
                MDButtonText:
                    text: "Envoyer le code"
            MDButton:
                style: "text"
                pos_hint: {"center_x": 0.5}
                on_release: root.manager.current = "login"
                MDButtonText:
                    text: "Vous rappelez ? Se connecter"

<CodeInputScreen>:
    MDCard:
        style: "elevated"
        pos_hint: {"center_x": .5, "center_y": .5}
        padding: "4dp"
        size_hint: .5, .5
        # Sets custom properties.
        theme_shadow_color: "Custom"
        shadow_color: "green"
        theme_bg_color: "Custom"
        MDBoxLayout:
            orientation: "vertical"
            spacing: "10dp"
            MDTextField:
                id: reset_code
                size_hint_x: .5
                pos_hint: {"center_x": 0.5}
                required: True
                MDTextFieldHintText:
                    text: "Code reçu par mail"
                MDTextFieldHelperText:
                    mode: "on_error"

            MDTextField:
                id: new_password
                required: True
                password: True
                size_hint_x: .5
                pos_hint: {"center_x": 0.5}
                MDTextFieldHintText:
                    text: "Nouveau mot de passe"

            MDButton:
                style: "elevated"
                pos_hint: {"center_x": 0.5}
                on_release: app.reset_password()
                MDButtonText:
                    text: "Valider"
            
            MDButton:
                style: "text"
                pos_hint: {"center_x": 0.5}
                on_release: root.manager.current = "login"
                MDButtonText:
                    text: "Retour à la connexion"

<VisitorRow>:
    orientation: "horizontal"
    size_hint_y: None
    height: dp(70)
    spacing: dp(16)
    MDCheckbox:
        id: select_checkbox
        group: "child"
        size_hint_x: None
        width: dp(32)
        active: root.selected
        on_active: app.on_select_visitor(root, self.active)
    FitImage:
        source: root.image_path
        size_hint_x: 0.08
        size_hint_y: None
        size: dp(32), dp(32)
        radius: [16]
    MDLabel:
        text: root.nom
        halign: "center"
        size_hint_x: 0.08
    MDLabel:
        text: root.prenom
        halign: "left"
        size_hint_x: 0.08
    MDLabel:
        text: root.phone_number
        halign: "left"
        size_hint_x: 0.08
    MDLabel:
        text: root.id_type
        halign: "left"
        size_hint_x: 0.08
    MDLabel:
        text: root.id_number
        halign: "left"
        size_hint_x: 0.08
    MDLabel:
        text: root.motif
        halign: "left"
        size_hint_x: 0.1
    MDLabel:
        text: root.date
        halign: "left"
        size_hint_x: 0.08
    MDLabel:
        text: root.arrival_time
        halign: "center"
        size_hint_x: 0.08
    MDLabel:
        text: root.exit_time
        halign: "center"
        size_hint_x: 0.08
    MDLabel:
        text: root.observation
        halign: "center"
        size_hint_x: 0.08
    MDIconButton:
        icon: "logout" if app.root.current == "accueil" else "pencil-outline"
        size_hint: None, None
        size: dp(36), dp(36)
        tooltip_text: "Enregistrer la sortie"
        focus: True
        on_release: app.ouvrir_dialogue_sortie(root) if app.root.current == "accueil" else app.ouvrir_dialogue_modification(root)

<VisitorTable@RecycleView>:
    viewclass: "VisitorRow"
    scroll_distance: dp(50)
    bar_width: dp(5)
    bar_color: 0, 0, 0, 1
    RecycleBoxLayout:
        default_size: None, dp(40)
        default_size_hint: 1, None
        size_hint_y: None
        height: self.minimum_height
        orientation: "vertical"
        spacing: dp(16)
        padding: [dp(8), dp(8), dp(8), dp(8)]


<AccueilScreen>:
    MDBoxLayout:
        orientation: 'vertical'
        padding: [20, 20, 20, 20]
        spacing: 20

        # Partie supérieure (10%)
        MDBoxLayout:
            orientation: 'horizontal'
            size_hint_y: 0.1
            spacing: dp(16)
            MDLabel:
                text: "Liste des visiteurs du jour"
                font_style: "Title"
                halign: "left"
                valign: "middle"
                bold: True

            MDExtendedFabButton:
                id: add_visitor_btn
                height: dp(48)
                pos_hint: {"center_y": 0.5}
                on_enter: self.fab_state = "expand"
                on_leave: self.fab_state = "collapse"
                on_release: app.ouvrir_dialogue_ajout_visiteur()
                MDExtendedFabButtonIcon:
                    icon: "account-plus"
                MDExtendedFabButtonText:
                    text: "Ajouter un visiteur"
            
            MDExtendedFabButton:
                id: share_btn
                height: dp(48)
                pos_hint: {"center_y": 0.5}
                disabled: not root.partager_visible
                on_enter: self.fab_state = "expand"
                on_leave: self.fab_state = "collapse"
                on_release: app.ouvrir_dialogue_partager()
                MDExtendedFabButtonIcon:
                    icon: "share"
                MDExtendedFabButtonText:
                    text: "Partager"
        
        MDDivider:
            height: "2dp"
        
        # Partie inférieure (90%)
        MDBoxLayout:
            orientation: 'vertical'
            size_hint_y: 0.9
            padding: 10
            spacing: 20
            padding: [dp(8), 0, dp(8), 0]

            MDBoxLayout:
                orientation: 'horizontal'
                size_hint_y: 0.1
                spacing: dp(16)
                MDCheckbox:
                    id: select_all_checkbox
                    group: "root"
                    size_hint_x: None
                    width: dp(32)
                    on_active: app.on_select_all_visitors(self.active)
                MDDivider:
                    height: "2dp"
                    orientation: "vertical"
                MDLabel:
                    text: "Image"
                    bold: True
                    theme_text_color: "Primary"
                    halign: "left"
                    size_hint_x: 0.08
                MDDivider:
                    height: "2dp"
                    orientation: "vertical"
                MDLabel:
                    text: "Nom"
                    bold: True
                    theme_text_color: "Primary"
                    halign: "center"
                    size_hint_x: 0.08
                MDDivider:
                    height: "2dp"
                    orientation: "vertical"
                MDLabel:
                    text: "Prénom"
                    bold: True
                    theme_text_color: "Primary"
                    halign: "left"
                    size_hint_x: 0.08
                MDDivider:
                    height: "2dp"
                    orientation: "vertical"
                MDLabel:
                    text: "Téléphone"
                    bold: True
                    theme_text_color: "Primary"
                    halign: "left"
                    size_hint_x: 0.08
                    font_size: self.width * 0.1
                MDDivider:
                    height: "2dp"
                    orientation: "vertical"
                MDLabel:
                    text: "Type de la carte"
                    bold: True
                    theme_text_color: "Primary"
                    halign: "left"
                    size_hint_x: 0.08
                MDDivider:
                    height: "2dp"
                    orientation: "vertical"
                MDLabel:
                    text: "N° de la carte"
                    bold: True
                    theme_text_color: "Primary"
                    halign: "left"    
                    size_hint_x: 0.08
                MDDivider:
                    height: "2dp"
                    orientation: "vertical"
                MDLabel:
                    text: "Motif"
                    bold: True
                    theme_text_color: "Primary"
                    halign: "left"
                    size_hint_x: 0.1
                MDDivider:
                    height: "2dp"
                    orientation: "vertical"
                MDLabel:
                    text: "Date"
                    bold: True
                    theme_text_color: "Primary"
                    halign: "left"
                    size_hint_x: 0.08
                MDDivider:
                    height: "2dp"
                    orientation: "vertical"
                MDLabel:
                    text: "Entrée"
                    bold: True
                    theme_text_color: "Primary"
                    halign: "center"
                    size_hint_x: 0.08
                MDDivider:
                    height: "2dp"
                    orientation: "vertical"
                MDLabel:
                    text: "Sortie"
                    bold: True
                    theme_text_color: "Primary"
                    halign: "center"
                    size_hint_x: 0.08
                MDDivider:
                    height: "2dp"
                    orientation: "vertical"
                MDLabel:
                    text: "Observation"
                    bold: True
                    theme_text_color: "Primary"
                    halign: "left"
                    size_hint_x: 0.08
                MDDivider:
                    height: "2dp"
                    orientation: "vertical"
                MDIconButton:
                    icon: "history"
                    size_hint: None, None
                    size: dp(36), dp(36)
                    focus: True
                    tooltip_text: "Enregistrer la sortie"
                    on_release: app.root.current = "historique"

            MDDivider:
                height: "2dp"
            VisitorTable:
                id: table_visiteurs

<HistoriqueScreen>:
    MDBoxLayout:
        orientation: "vertical"
        padding: [20, 20, 20, 20]
        spacing: 30

        MDBoxLayout:
            orientation: "horizontal"
            size_hint_y: None
            height: dp(56)
            spacing: dp(16)

            MDLabel:
                text: "Liste de tous les visiteurs"
                font_style: "Title"
                halign: "left"
                valign: "middle"
                bold: True

            MDTextField:
                id: year_filter
                mode: "outlined"
                size_hint_x: 0.23
                focus: True
                on_focus: if self.focus: root.open_menu("year_filter")
                MDTextFieldHintText:
                    text: "Années"
            MDTextField:
                id: month_filter
                mode: "outlined"
                size_hint_x: 0.2
                focus: True
                on_focus: if self.focus: root.open_menu("month_filter")
                MDTextFieldHintText:
                    text: "Mois"
            MDTextField:
                id: day_filter
                mode: "outlined"
                size_hint_x: 0.2
                focus: True
                on_focus: if self.focus: root.open_menu("day_filter")
                MDTextFieldHintText:
                    text: "Jours"

            MDIconButton:
                icon: "filter"
                style: "tonal"
                theme_bg_color: "Custom"
                md_bg_color: "blue"
                theme_icon_color: "Custom"
                icon_color: "white"
                pos_hint: {"center_y": 0.5}
                on_release: root.filtrer_historique(year_filter.text, month_filter.text, day_filter.text)

            MDIconButton:
                icon: "reload"
                style: "tonal"
                theme_bg_color: "Custom"
                md_bg_color: "green"
                theme_icon_color: "Custom"
                icon_color: "white"
                pos_hint: {"center_y": 0.5}
                on_release: root.reinitialiser_filtre()
            
            MDIconButton:
                icon: "home"
                style: "tonal"
                theme_bg_color: "Custom"
                md_bg_color: "brown"
                theme_icon_color: "Custom"
                icon_color: "white"
                pos_hint: {"center_y": 0.5}
                on_release: app.root.current = "accueil"
            MDExtendedFabButton:
                id: share_btn
                height: dp(48)
                pos_hint: {"center_y": 0.5}
                disabled: not root.partager_visible
                on_enter: self.fab_state = "expand"
                on_leave: self.fab_state = "collapse"
                on_release: app.ouvrir_dialogue_partager()
                MDExtendedFabButtonIcon:
                    icon: "share"
                MDExtendedFabButtonText:
                    text: "Partager"

        MDDivider:
            height: "2dp"

        MDBoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: dp(50)
            spacing: dp(16)
            MDCheckbox:
                id: select_all_checkbox
                group: "root"
                size_hint_x: None
                width: dp(32)
                on_active: app.on_select_all_visitors(self.active)
            MDDivider:
                height: "2dp"
                orientation: "vertical"
            MDLabel:
                text: "Image"
                bold: True
                theme_text_color: "Primary"
                halign: "left"
                size_hint_x: 0.08
            MDDivider:
                height: "2dp"
                orientation: "vertical"
            MDLabel:
                text: "Nom"
                bold: True
                theme_text_color: "Primary"
                halign: "center"
                size_hint_x: 0.08
            
            MDDivider:
                height: "2dp"
                orientation: "vertical"
            MDLabel:
                text: "Prénom"
                bold: True
                theme_text_color: "Primary"
                halign: "left"
                size_hint_x: 0.08
            MDDivider:
                height: "2dp"
                orientation: "vertical"
            MDLabel:
                text: "Téléphone"
                bold: True
                theme_text_color: "Primary"
                halign: "left"
                size_hint_x: 0.08
            MDDivider:
                height: "2dp"
                orientation: "vertical"
            MDLabel:
                text: "Type de la carte"
                bold: True
                theme_text_color: "Primary"
                halign: "left"
                size_hint_x: 0.08
            MDDivider:
                height: "2dp"
                orientation: "vertical"
            MDLabel:
                text: "N° de la carte"
                bold: True
                theme_text_color: "Primary"
                halign: "left"    
                size_hint_x: 0.08
            MDDivider:
                height: "2dp"
                orientation: "vertical"
            MDLabel:
                text: "Motif"
                bold: True
                theme_text_color: "Primary"
                halign: "left"
                size_hint_x: 0.1
            MDDivider:
                height: "2dp"
                orientation: "vertical"
            MDLabel:
                text: "Date"
                bold: True
                theme_text_color: "Primary"
                halign: "left"
                size_hint_x: 0.08
            MDDivider:
                height: "2dp"
                orientation: "vertical"
            MDLabel:
                text: "Entrée"
                bold: True
                theme_text_color: "Primary"
                halign: "center"
                size_hint_x: 0.08
            MDDivider:
                height: "2dp"
                orientation: "vertical"
            MDLabel:
                text: "Sortie"
                bold: True
                theme_text_color: "Primary"
                halign: "center"
                size_hint_x: 0.08
            MDDivider:
                height: "2dp"
                orientation: "vertical"
            MDLabel:
                text: "Observation"
                bold: True
                theme_text_color: "Primary"
                halign: "left"
                size_hint_x: 0.08
            MDDivider:
                height: "2dp"
                orientation: "vertical"
            MDLabel:
                text: ""
                bold: True
                theme_text_color: "Primary"
                halign: "left"
                size_hint_x: None
                width: dp(36)
        
        MDDivider:
            height: "2dp"

        VisitorTable:
            id: historique_table