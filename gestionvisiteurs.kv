#:kivy 2.3.1
#:import MDBoxLayout kivymd.uix.boxlayout.MDBoxLayout
#:import MDButton kivymd.uix.button.MDButton
#:import MDLabel kivymd.uix.label.MDLabel
#:import dp kivy.metrics.dp
#:import ScreenManager kivy.uix.screenmanager.ScreenManager

ScreenManager:
    canvas.before:
        Color:
            rgba: 0.95, 0.97, 1, 1
        Rectangle:
            pos: self.pos
            size: self.size
    AccueilScreen:
        name: "accueil"
    HistoriqueScreen:
        name: "historique"

<VisitorRow>:
    orientation: "horizontal"
    size_hint_y: None
    height: dp(48)
    spacing: dp(16)
    MDCheckbox:
        id: select_checkbox
        group: "child"
        size_hint_x: None
        width: dp(32)
        active: root.selected
        on_active: app.on_select_visitor(root, self.active)
    FitImage:
        source: root.image_path
        size_hint_x: 0.08
        size_hint_y: None
        size: dp(32), dp(32)
        radius: [16]
    MDLabel:
        text: root.nom
        halign: "center"
        size_hint_x: 0.08
    MDLabel:
        text: root.prenom
        halign: "left"
        size_hint_x: 0.08
    MDLabel:
        text: root.phone_number
        halign: "left"
        size_hint_x: 0.08
    MDLabel:
        text: root.id_type
        halign: "left"
        size_hint_x: 0.08
    MDLabel:
        text: root.id_number
        halign: "left"
        size_hint_x: 0.08
    MDLabel:
        text: root.motif
        halign: "left"
        size_hint_x: 0.08
    MDLabel:
        text: root.date
        halign: "left"
        size_hint_x: 0.08
    MDLabel:
        text: root.arrival_time
        halign: "center"
        size_hint_x: 0.08
    MDLabel:
        text: root.exit_time
        halign: "center"
        size_hint_x: 0.08
    MDLabel:
        text: root.observation
        halign: "center"
        size_hint_x: 0.08
    MDIconButton:
        icon: "logout" if app.root.current == "accueil" else "pencil-outline"
        size_hint: None, None
        size: dp(36), dp(36)
        tooltip_text: "Enregistrer la sortie"
        on_release: app.ouvrir_dialogue_sortie(root) if app.root.current == "accueil" else app.ouvrir_dialogue_modification(root)

<VisitorTable@RecycleView>:
    viewclass: "VisitorRow"
    scroll_distance: dp(50)
    bar_width: dp(5)
    bar_color: 0, 0, 0, 1
    RecycleBoxLayout:
        default_size: None, dp(40)
        default_size_hint: 1, None
        size_hint_y: None
        height: self.minimum_height
        orientation: "vertical"
        spacing: dp(16)
        padding: [dp(8), dp(8), dp(8), dp(8)]


<AccueilScreen>:
    MDBoxLayout:
        orientation: 'vertical'
        padding: [20, 20, 20, 20]
        spacing: 20

        # Partie supérieure (20%)
        MDBoxLayout:
            orientation: 'horizontal'
            size_hint_y: 0.2
            spacing: dp(16)

            MDLabel:
                text: "Liste des visiteurs du jour"
                font_style: "Title"
                halign: "left"
                valign: "middle"
                bold: True

            MDButton:
                size_hint_x: 0.25
                height: dp(48)
                pos_hint: {"center_y": 0.5}
                tooltip_text: "Ajouter un visiteur"
                on_release: app.ouvrir_dialogue_ajout_visiteur()
                MDButtonIcon:
                    icon: "account-plus"
                MDButtonText:
                    text: "Ajouter un visiteur"
            
            MDButton:
                size_hint_x: 0.25
                height: dp(48)
                pos_hint: {"center_y": 0.5}
                tooltip_text: "Partager la base de données"
                disabled: not root.partager_visible
                # md_bg_color_disabled: 0.8, 0.8, 0.8, 1
                on_release: app.ouvrir_dialogue_partager()

                MDButtonIcon:
                    icon: "share"
                MDButtonText:
                    text: "Partager"

            MDButton:
                size_hint_x: 0.25
                height: dp(48)
                pos_hint: {"center_y": 0.5}
                tooltip_text: "Exporter les visiteurs"
                on_release: app.exporter_visiteurs()
                MDButtonIcon:
                    icon: "export"
                MDButtonText:
                    text: "Exporter"

            MDButton:
                size_hint_x: 0.25
                height: dp(48)
                pos_hint: {"center_y": 0.5}
                tooltip_text: "Importer des visiteurs"
                on_release: app.importer_visiteurs()
                MDButtonIcon:
                    icon: "import"
                MDButtonText:
                    text: "Importer"
        
        MDDivider:
            height: "2dp"
        
        # Partie inférieure (80%)
        MDBoxLayout:
            orientation: 'vertical'
            size_hint_y: 0.8
            padding: 10
            spacing: 20
            padding: [dp(8), 0, dp(8), 0]

            MDBoxLayout:
                orientation: 'horizontal'
                size_hint_y: None
                height: dp(50)
                spacing: dp(16)
                MDCheckbox:
                    id: select_all_checkbox
                    group: "root"
                    size_hint_x: None
                    width: dp(32)
                    on_active: app.on_select_all_visitors(self.active)
                MDDivider:
                    height: "2dp"
                    orientation: "vertical"
                MDLabel:
                    text: "Image"
                    bold: True
                    theme_text_color: "Primary"
                    halign: "left"
                    size_hint_x: 0.08
                MDDivider:
                    height: "2dp"
                    orientation: "vertical"
                MDLabel:
                    text: "Nom"
                    bold: True
                    theme_text_color: "Primary"
                    halign: "center"
                    size_hint_x: 0.08
                MDDivider:
                    height: "2dp"
                    orientation: "vertical"
                MDLabel:
                    text: "Prénom"
                    bold: True
                    theme_text_color: "Primary"
                    halign: "left"
                    size_hint_x: 0.08
                MDDivider:
                    height: "2dp"
                    orientation: "vertical"
                MDLabel:
                    text: "N° de téléphone"
                    bold: True
                    theme_text_color: "Primary"
                    halign: "left"
                    size_hint_x: 0.08
                    font_size: self.width * 0.1
                MDDivider:
                    height: "2dp"
                    orientation: "vertical"
                MDLabel:
                    text: "Type de la carte"
                    bold: True
                    theme_text_color: "Primary"
                    halign: "left"
                    size_hint_x: 0.08
                MDDivider:
                    height: "2dp"
                    orientation: "vertical"
                MDLabel:
                    text: "N° de la carte"
                    bold: True
                    theme_text_color: "Primary"
                    halign: "left"    
                    size_hint_x: 0.08
                MDDivider:
                    height: "2dp"
                    orientation: "vertical"
                MDLabel:
                    text: "Motif"
                    bold: True
                    theme_text_color: "Primary"
                    halign: "left"
                    size_hint_x: 0.08
                MDDivider:
                    height: "2dp"
                    orientation: "vertical"
                MDLabel:
                    text: "Date"
                    bold: True
                    theme_text_color: "Primary"
                    halign: "left"
                    size_hint_x: 0.08
                MDDivider:
                    height: "2dp"
                    orientation: "vertical"
                MDLabel:
                    text: "Heure d'entrée"
                    bold: True
                    theme_text_color: "Primary"
                    halign: "center"
                    size_hint_x: 0.08
                MDDivider:
                    height: "2dp"
                    orientation: "vertical"
                MDLabel:
                    text: "Heure de sortie"
                    bold: True
                    theme_text_color: "Primary"
                    halign: "center"
                    size_hint_x: 0.08
                MDDivider:
                    height: "2dp"
                    orientation: "vertical"
                MDLabel:
                    text: "Observation"
                    bold: True
                    theme_text_color: "Primary"
                    halign: "left"
                    size_hint_x: 0.08
                MDDivider:
                    height: "2dp"
                    orientation: "vertical"
                MDIconButton:
                    icon: "history"
                    size_hint: None, None
                    size: dp(36), dp(36)
                    tooltip_text: "Enregistrer la sortie"
                    on_release: app.root.current = "historique"

            MDDivider:
                height: "2dp"
            # La DataTable sera ajoutée dynamiquement depuis le code Python
            VisitorTable:
                id: table_visiteurs
        # MDBoxLayout:
        #     orientation: "horizontal"
        #     size_hint_y: None
        #     height: dp(40)
        #     spacing: dp(10)
        #     MDButton:
        #         on_release: root.scroll_table_up()
        #         MDButtonIcon:
        #             icon: "arrow-up"
        #     MDButton:
        #         on_release: root.scroll_table_down()
        #         MDButtonIcon:
        #             icon: "arrow-down"

<HistoriqueScreen>:
    MDBoxLayout:
        orientation: "vertical"
        padding: [20, 20, 20, 20]
        spacing: 30

        MDBoxLayout:
            orientation: "horizontal"
            size_hint_y: None
            height: dp(56)
            spacing: dp(16)

            MDLabel:
                text: "Liste de tous les visiteurs"
                font_style: "Title"
                halign: "left"
                valign: "middle"
                bold: True

            MDTextField:
                id: year_filter
                mode: "outlined"
                size_hint_x: 0.23
                on_focus: if self.focus: root.open_menu("year_filter")
                MDTextFieldHintText:
                    text: "Années"
            MDTextField:
                id: month_filter
                mode: "outlined"
                size_hint_x: 0.2
                on_focus: if self.focus: root.open_menu("month_filter")
                MDTextFieldHintText:
                    text: "Mois"
            MDTextField:
                id: day_filter
                mode: "outlined"
                size_hint_x: 0.2
                on_focus: if self.focus: root.open_menu("day_filter")
                MDTextFieldHintText:
                    text: "Jours"

            MDIconButton:
                icon: "filter"
                style: "tonal"
                theme_bg_color: "Custom"
                md_bg_color: "blue"
                theme_icon_color: "Custom"
                icon_color: "white"
                on_release: root.filtrer_historique(year_filter.text, month_filter.text, day_filter.text)

            MDIconButton:
                icon: "reload"
                style: "tonal"
                theme_bg_color: "Custom"
                md_bg_color: "green"
                theme_icon_color: "Custom"
                icon_color: "white"
                on_release: root.reinitialiser_filtre()
            
            MDIconButton:
                icon: "home"
                style: "tonal"
                theme_bg_color: "Custom"
                md_bg_color: "brown"
                theme_icon_color: "Custom"
                icon_color: "white"
                on_release: app.root.current = "accueil"

        MDDivider:
            height: "2dp"

        MDBoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: dp(50)
            spacing: dp(16)
            MDCheckbox:
                id: select_all_checkbox
                group: "root"
                size_hint_x: None
                width: dp(32)
                on_active: app.on_select_all_visitors(self.active)
            MDDivider:
                height: "2dp"
                orientation: "vertical"
            MDLabel:
                text: "Image"
                bold: True
                theme_text_color: "Primary"
                halign: "left"
                size_hint_x: 0.08
            MDDivider:
                height: "2dp"
                orientation: "vertical"
            MDLabel:
                text: "Nom"
                bold: True
                theme_text_color: "Primary"
                halign: "center"
                size_hint_x: 0.08
            
            MDDivider:
                height: "2dp"
                orientation: "vertical"
            MDLabel:
                text: "Prénom"
                bold: True
                theme_text_color: "Primary"
                halign: "left"
                size_hint_x: 0.08
            MDDivider:
                height: "2dp"
                orientation: "vertical"
            MDLabel:
                text: "N° de téléphone"
                bold: True
                theme_text_color: "Primary"
                halign: "left"
                size_hint_x: 0.08
            MDDivider:
                height: "2dp"
                orientation: "vertical"
            MDLabel:
                text: "Type de la carte"
                bold: True
                theme_text_color: "Primary"
                halign: "left"
                size_hint_x: 0.08
            MDDivider:
                height: "2dp"
                orientation: "vertical"
            MDLabel:
                text: "N° de la carte"
                bold: True
                theme_text_color: "Primary"
                halign: "left"    
                size_hint_x: 0.08
            MDDivider:
                height: "2dp"
                orientation: "vertical"
            MDLabel:
                text: "Motif"
                bold: True
                theme_text_color: "Primary"
                halign: "left"
                size_hint_x: 0.08
            MDDivider:
                height: "2dp"
                orientation: "vertical"
            MDLabel:
                text: "Date"
                bold: True
                theme_text_color: "Primary"
                halign: "left"
                size_hint_x: 0.08
            MDDivider:
                height: "2dp"
                orientation: "vertical"
            MDLabel:
                text: "Heure d'entrée"
                bold: True
                theme_text_color: "Primary"
                halign: "center"
                size_hint_x: 0.08
            MDDivider:
                height: "2dp"
                orientation: "vertical"
            MDLabel:
                text: "Heure de sortie"
                bold: True
                theme_text_color: "Primary"
                halign: "center"
                size_hint_x: 0.08
            MDDivider:
                height: "2dp"
                orientation: "vertical"
            MDLabel:
                text: "Observation"
                bold: True
                theme_text_color: "Primary"
                halign: "left"
                size_hint_x: 0.08
            MDDivider:
                height: "2dp"
                orientation: "vertical"
            MDLabel:
                text: ""
                bold: True
                theme_text_color: "Primary"
                halign: "left"
                size_hint_x: None
                width: dp(36)
        
        MDDivider:
            height: "2dp"

        VisitorTable:
            id: historique_table